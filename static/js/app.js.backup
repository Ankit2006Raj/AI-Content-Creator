// ========================================
// Main Application JavaScript
// ========================================

// Tab Management
let activeTab = 'generate';

function initApp() {
    setupTabs();
    setupEventListeners();
    createParticles();
    
    // Make voice manager globally available when it's ready
    setTimeout(() => {
        if (window.voiceManager) {
            console.log('‚úÖ Voice Manager is ready!');
        }
    }, 1000);
}

// Test Voice Capabilities on Load
function testVoiceCapabilities() {
    // Test Speech Recognition
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    if (!recognition && voiceInputBtn) {
        voiceInputBtn.classList.add('voice-not-available');
        voiceInputBtn.title = 'Voice input not supported in this browser';
    }
    
    // Test Speech Synthesis
    if (!('speechSynthesis' in window)) {
        document.querySelectorAll('.voice-play-btn').forEach(btn => {
            btn.classList.add('voice-not-available');
            btn.title = 'Text-to-speech not supported in this browser';
        });
    }
    
    // Show capabilities summary
    setTimeout(() => {
        const recognitionSupported = !!recognition;
        const synthesisSupported = 'speechSynthesis' in window;
        
        if (recognitionSupported && synthesisSupported) {
            console.log('‚úÖ Full voice support: Speech recognition and synthesis available');
        } else if (recognitionSupported) {
            console.log('‚ö†Ô∏è Partial voice support: Only speech recognition available');
            showAlert('Text-to-speech not supported in this browser', 'error');
        } else if (synthesisSupported) {
            console.log('‚ö†Ô∏è Partial voice support: Only text-to-speech available');
        } else {
            console.log('‚ùå No voice support available');
            showAlert('Voice features not supported in this browser. Please use Chrome or Edge.', 'error');
        }
    }, 500);
}

function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            switchTab(tab);
        });
    });
}

function switchTab(tab) {
    activeTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
            btn.classList.add('active');
        }
    });
    
    // Show/hide content sections
    document.querySelectorAll('.tab-content').forEach(section => {
        section.classList.add('hidden');
    });
    
    document.getElementById(`${tab}-section`).classList.remove('hidden');
    
    // Clear previous results
    clearResults();
}

function setupEventListeners() {
    // Generate button
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
        generateBtn.addEventListener('click', handleGenerate);
    }
    
    // Summarize button
    const summarizeBtn = document.getElementById('summarizeBtn');
    if (summarizeBtn) {
        summarizeBtn.addEventListener('click', handleSummarize);
    }
    
    // Copy buttons
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('copy-btn')) {
            copyToClipboard(e.target);
        }
    });
}

// Content Generation
async function handleGenerate() {
    const prompt = document.getElementById('generatePrompt').value.trim();
    const contentType = document.getElementById('contentType').value;
    const tone = document.getElementById('tone').value;
    const length = document.getElementById('length').value;
    
    if (!prompt) {
        showAlert('Please enter a prompt', 'error');
        return;
    }
    
    const generateBtn = document.getElementById('generateBtn');
    const resultSection = document.getElementById('generate-result');
    const resultContent = document.getElementById('generate-result-content');
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="loading"></span> Generating...';
    resultSection.classList.add('hidden');
    clearAlerts();
    
    try {
        const response = await fetch('/api/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt,
                contentType,
                tone,
                length
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            resultContent.textContent = data.content;
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            showAlert(data.error || 'Failed to generate content', 'error');
        }
    } catch (error) {
        showAlert('Network error: ' + error.message, 'error');
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<span>‚ú®</span> Generate Content';
    }
}

// Content Summarization
async function handleSummarize() {
    const text = document.getElementById('summarizeText').value.trim();
    const summaryType = document.getElementById('summaryType').value;
    
    if (!text) {
        showAlert('Please enter text to summarize', 'error');
        return;
    }
    
    if (text.length < 50) {
        showAlert('Text must be at least 50 characters long', 'error');
        return;
    }
    
    const summarizeBtn = document.getElementById('summarizeBtn');
    const resultSection = document.getElementById('summarize-result');
    const resultContent = document.getElementById('summarize-result-content');
    
    // Show loading state
    summarizeBtn.disabled = true;
    summarizeBtn.innerHTML = '<span class="loading"></span> Summarizing...';
    resultSection.classList.add('hidden');
    clearAlerts();
    
    try {
        const response = await fetch('/api/summarize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text,
                summaryType
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            resultContent.textContent = data.summary;
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            showAlert(data.error || 'Failed to summarize content', 'error');
        }
    } catch (error) {
        showAlert('Network error: ' + error.message, 'error');
    } finally {
        summarizeBtn.disabled = false;
        summarizeBtn.innerHTML = '<span>üìù</span> Summarize';
    }
}

// Utility Functions
function clearResults() {
    document.querySelectorAll('.result-section').forEach(section => {
        section.classList.add('hidden');
    });
    clearAlerts();
}

function clearAlerts() {
    document.querySelectorAll('.alert').forEach(alert => {
        alert.remove();
    });
}

function showAlert(message, type = 'error') {
    clearAlerts();
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <span>${type === 'error' ? '‚ö†Ô∏è' : '‚úì'}</span>
        <span>${message}</span>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alert, container.firstChild);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        alert.style.opacity = '0';
        alert.style.transform = 'translateX(-20px)';
        setTimeout(() => alert.remove(), 400);
    }, 5000);
}

async function copyToClipboard(button) {
    let text = '';
    
    if (activeTab === 'generate') {
        text = document.getElementById('generate-result-content').textContent;
    } else if (activeTab === 'summarize') {
        text = document.getElementById('summarize-result-content').textContent;
    }
    
    if (!text) return;
    
    try {
        await navigator.clipboard.writeText(text);
        
        // Visual feedback
        const originalText = button.innerHTML;
        button.innerHTML = '<span>‚úì</span> Copied!';
        button.style.background = 'var(--success)';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
        }, 2000);
    } catch (error) {
        showAlert('Failed to copy to clipboard', 'error');
    }
}

function createParticles() {
    const container = document.body;
    const particleCount = 20;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 15 + 's';
        particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
        container.appendChild(particle);
    }
}

// Voice functionality is now handled by voice-manager.js

// Voice functionality is now handled by voice-manager.js

// Voice functionality is now handled by voice-manager.js

// Voice functionality is now handled by voice-manager.js

// Voice functionality is now handled by voice-manager.js

// Pause Content
function pauseContent() {
    if (isSpeaking && currentUtterance) {
        speechSynthesis.cancel();
        isSpeaking = false;
        
        // Update UI
        document.querySelectorAll('.voice-play-btn').forEach(btn => {
            btn.classList.remove('hidden');
            if (btn.id === 'playGeneratedContent') {
                btn.innerHTML = '<span>üîä</span> Listen to Content';
            } else if (btn.id === 'playSummaryContent') {
                btn.innerHTML = '<span>üîä</span> Listen to Summary';
            }
        });
        
        document.querySelectorAll('.voice-pause-btn').forEach(btn => {
            btn.classList.add('hidden');
        });
    }
}

// Load voices when available
speechSynthesis.onvoiceschanged = function() {
    const voices = speechSynthesis.getVoices();
    console.log('Available voices:', voices.map(v => ({ name: v.name, lang: v.lang })));
    updateVoiceOptions(voices);
};

// Update Voice Options based on available voices
function updateVoiceOptions(voices) {
    const voiceTypeSelect = document.getElementById('voiceType');
    if (!voiceTypeSelect) return;
    
    // Check for Hindi voices
    const hindiVoices = voices.filter(voice => 
        voice.lang.includes('hi') || voice.lang.includes('IN')
    );
    
    // Check for English voices
    const englishVoices = voices.filter(voice => 
        voice.lang.includes('en')
    );
    
    // Update options based on availability
    const options = voiceTypeSelect.querySelectorAll('option');
    options.forEach(option => {
        const value = option.value;
        if (value.includes('hi') && hindiVoices.length === 0) {
            option.style.display = 'none';
            option.disabled = true;
        } else if (value.includes('en') && englishVoices.length === 0) {
            option.style.display = 'none';
            option.disabled = true;
        } else {
            option.style.display = 'block';
            option.disabled = false;
        }
    });
    
    // Add voice count information
    if (hindiVoices.length > 0) {
        console.log(`Found ${hindiVoices.length} Hindi voices:`, hindiVoices.map(v => v.name));
    }
    if (englishVoices.length > 0) {
        console.log(`Found ${englishVoices.length} English voices:`, englishVoices.map(v => v.name));
    }
    
    // Show alert about voice availability
    if (hindiVoices.length === 0 && englishVoices.length === 0) {
        showAlert('No voices available for text-to-speech. Please check your system settings.', 'error');
    } else if (hindiVoices.length === 0) {
        showAlert('Hindi voices not available. English voices will be used.', 'error');
    }
}

// Check Voice Support
function checkVoiceSupport() {
    if ('speechSynthesis' in window) {
        // Force load voices
        speechSynthesis.getVoices();
        
        // Set a timeout to check again if voices aren't loaded immediately
        setTimeout(() => {
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                console.warn('No voices loaded yet, will retry...');
                setTimeout(() => {
                    updateVoiceOptions(speechSynthesis.getVoices());
                }, 1000);
            }
        }, 100);
        
        return true;
    } else {
        console.warn('Speech synthesis not supported');
        document.querySelectorAll('.voice-play-btn, .voice-pause-btn').forEach(btn => {
            btn.style.display = 'none';
        });
        return false;
    }
}

// Test Voice Function
function testVoice() {
    if (isSpeaking) {
        speechSynthesis.cancel();
    }
    
    const voiceType = document.getElementById('voiceType').value;
    const voiceLanguage = document.getElementById('voiceLanguage').value;
    const voiceSpeed = parseFloat(document.getElementById('voiceSpeed').value);
    
    // Test messages in different languages
    const testMessages = {
        'hi': '‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ AI ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§Ç‡§ü ‡§π‡•Ç‡§Ç‡•§ ‡§Æ‡•à‡§Ç ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§î‡§∞ ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≠‡§æ‡§∑‡§æ‡§ì‡§Ç ‡§Æ‡•á‡§Ç ‡§¨‡•ã‡§≤ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç‡•§',
        'en': 'Hello! I am your AI assistant. I can speak in both Hindi and English languages.',
        'auto': 'Hello! ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! This is a test of multilingual text-to-speech capabilities.'
    };
    
    let testText = testMessages[voiceLanguage] || testMessages['en'];
    
    currentUtterance = new SpeechSynthesisUtterance(testText);
    
    // Get available voices
    const voices = speechSynthesis.getVoices();
    let selectedVoice = findBestVoice(voices, voiceType, voiceLanguage, testText);
    
    if (selectedVoice) {
        currentUtterance.voice = selectedVoice;
    }
    
    currentUtterance.rate = voiceSpeed;
    currentUtterance.pitch = 1;
    currentUtterance.volume = 1;
    
    currentUtterance.onstart = function() {
        showAlert(`Testing voice: ${selectedVoice ? selectedVoice.name : 'Default voice'}`, 'success');
    };
    
    currentUtterance.onend = function() {
        showAlert('Voice test completed!', 'success');
    };
    
    currentUtterance.onerror = function(event) {
        console.error('Voice test error:', event);
        showAlert('Voice test failed. Please try a different voice type.', 'error');
    };
    
    speechSynthesis.speak(currentUtterance);
}

// Enhanced Error Messages with Hindi Support
function getLocalizedErrorMessage(error, language) {
    const messages = {
        'network': {
            'hi': '‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§è‡§∞‡§∞‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§',
            'en': 'Network error. Please check your internet connection.'
        },
        'not-allowed': {
            'hi': '‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•Ä ‡§ó‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç‡•§',
            'en': 'Microphone access denied. Please allow microphone permission.'
        },
        'no-speech': {
            'hi': '‡§ï‡•ã‡§à ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§®‡§π‡•Ä‡§Ç ‡§∏‡•Å‡§®‡§æ‡§à ‡§¶‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§',
            'en': 'No speech detected. Please speak closer to the microphone.'
        }
    };
    
    return messages[error] ? messages[error][language] || messages[error]['en'] : 'Unknown error occurred';
}

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}

